# --- SCRIPT CONSOLIDADO FINAL: ANÁLISE CIRURGIA GERAL ---
# Versão para Repositório Público - (Rode este script completo do inicio ao fim)

# 1. CONFIGURAÇÃO E CARREGAMENTO DE PACOTES
library(tidyverse)
library(readxl)
library(lubridate)
library(scales)
library(stringr)

print("1. Pacotes carregados. Iniciando análise do artigo.")

# 2. CARREGAR DADOS E PRÉ-PROCESSAMENTO
# O arquivo ORIGINAL (com todas as especialidades) deve estar na mesma pasta do script.
file_path_original <- "Planilha bloco cirurgico.xlsx"

tryCatch({
  # Lendo o arquivo original
  dados_full <- read_excel(file_path_original) 
  
  # APLICAÇÃO DE LIMPEZA E CRIAÇÃO DE NOVAS VARIÁVEIS (Etapa Zero)
  dados_processados <- dados_full %>%
    mutate(
      # Conversão da IDADE
      anos = as.numeric(str_match(IDADE, "(\\d+)\\s*Anos")[, 2]),
      meses = as.numeric(str_match(IDADE, "(\\d+)\\s*Meses")[, 2]),
      IDADE_NUMERICA = replace_na(anos, 0) + (replace_na(meses, 0) / 12),
      
      # Conversão dos TEMPOS (Usando lógica de 'paste' para texto)
      DATA_BASE = as.Date(dmy_hms(DT_REALIZACAO)),
      INICIO_SALA = DATA_BASE + hm(HORA_I_SALA),
      FIM_SALA = DATA_BASE + hm(HORA_F_SALA),
      HR_I_CIRURIA = DATA_BASE + hm(HR_I_CIRURIA),
      HR_F_CIRURGIA = DATA_BASE + hm(HR_F_CIRURGIA),
      HORA_I_ANEST = DATA_BASE + hm(HORA_I_ANEST),
      HORA_F_ANEST = DATA_BASE + hm(HORA_F_ANEST),
      
      # Correção Overnight (Fim menor que Início)
      FIM_SALA = if_else(FIM_SALA < INICIO_SALA, FIM_SALA + days(1), FIM_SALA, missing = FIM_SALA),
      
      # Cálculo de Tempo de Sala e Criação de Faixas
      TEMPO_SALA_MINUTOS = as.numeric(difftime(FIM_SALA, INICIO_SALA, units = "mins")),
      TIPO_CIRURGIA = str_trim(TIPO_CIRURGIA), # Limpa espaços
      
      # Criação da variável para o Heatmap
      HORA_INICIO = hour(INICIO_SALA),
      PERIODO = case_when(
        HORA_INICIO >= 6 & HORA_INICIO < 12 ~ "Manhã",
        HORA_INICIO >= 12 & HORA_INICIO < 18 ~ "Tarde",
        TRUE ~ "Noite/Madrugada"
      ),
      
      # Criação da variável da especialidade (Para o comparativo)
      ESPECIALIDADE = str_to_upper(str_trim(DS_ESPECIALID))
    )
  
  # Filtramos a base para o nosso estudo principal (CG)
  dados_cg_limpos <- dados_processados %>%
    filter(ESPECIALIDADE == "CIRURGIA GERAL")
    
  print("2. Pré-processamento e Limpeza (dados_cg_limpos) concluídos.")

}, error = function(e) {
  stop(paste("ERRO CRÍTICO NA LEITURA:", e$message, "Verifique se o arquivo 'Planilha bloco cirurgico.xlsx' está na pasta."))
})


# 3. TESTES ESTATÍSTICOS E CÁLCULOS DE P-VALOR

# A. Normalidade (Shapiro-Wilk)
shapiro_result <- shapiro.test(dados_cg_limpos$TEMPO_SALA_MINUTOS[1:min(5000, nrow(dados_cg_limpos))])
p_shapiro <- format.pval(shapiro_result$p.value, digits = 3)

# B. Kruskal-Wallis (Tempo x Porte)
teste_kw <- kruskal.test(TEMPO_SALA_MINUTOS ~ PORTE, data = dados_cg_limpos)
p_kw <- format.pval(teste_kw$p.value, digits = 3)

# C. Mann-Whitney (Tempo x Urgência/Eletiva)
teste_mw <- wilcox.test(TEMPO_SALA_MINUTOS ~ TIPO_CIRURGIA, data = dados_cg_limpos)
p_mw <- format.pval(teste_mw$p.value, digits = 3)

# D. Qui-Quadrado (Tipo x Porte)
tabela_cruzada <- table(dados_cg_limpos$PORTE, dados_cg_limpos$TIPO_CIRURGIA)
teste_qui <- chisq.test(tabela_cruzada)
p_qui <- format.pval(teste_qui$p.value, digits = 3)

print("3. Testes estatísticos (p-valores) calculados.")


# 4. GERAÇÃO DOS 11 ARQUIVOS FINAIS (Salva em alta qualidade)

# 4.1 Funções auxiliares para plots e dados
dados_top5_comparativo <- dados_processados %>%
  count(ESPECIALIDADE, sort = TRUE) %>%
  head(5) %>%
  pull(ESPECIALIDADE)

# 4.2 Tabela de Medidas (Para resultados numéricos)
resumo_tempos <- dados_cg_limpos %>%
  summarise(
    SALA_Mediana = median(TEMPO_SALA_MINUTOS, na.rm=TRUE),
    SALA_Q3 = quantile(TEMPO_SALA_MINUTOS, 0.75, na.rm=TRUE),
    SALA_IQR_WIDTH = IQR(TEMPO_SALA_MINUTOS, na.rm=TRUE) # Medidas da Tabela 2
  )

print("4. Geração dos 11 arquivos de Figura/Tabela...")


# GRÁFICO 1: NORMALIDADE (Q-Q PLOT)
grafico_qq <- ggplot(dados_cg_limpos, aes(sample = TEMPO_SALA_MINUTOS)) +
  stat_qq(alpha = 0.5) + stat_qq_line(color = "red") +
  labs(subtitle = paste("Shapiro-Wilk p-valor =", p_shapiro)) + theme_minimal()
ggsave("Teste1_Normalidade.png", plot = grafico_qq, width = 8, height = 6)


# GRÁFICO 2: BOXPLOT TEMPO X PORTE (Kruskal-Wallis)
grafico_boxplot_porte <- dados_cg_limpos %>%
  filter(!is.na(PORTE) & !is.na(TEMPO_SALA_MINUTOS) & TEMPO_SALA_MINUTOS > 0) %>%
  ggplot(aes(x = PORTE, y = TEMPO_SALA_MINUTOS, fill = PORTE)) +
  geom_boxplot(outlier.colour = "red", outlier.alpha = 0.5) +
  labs(subtitle = paste("Kruskal-Wallis p-valor:", ifelse(teste_kw$p.value < 0.001, "< 0.001", paste("=", p_kw)))) +
  coord_cartesian(ylim = c(0, 400))
ggsave("Teste2_Comparacao_Porte.png", plot = grafico_boxplot_porte, width = 8, height = 6)


# GRÁFICO 3: ASSOCIAÇÃO TIPO X PORTE (Qui-Quadrado)
grafico_qui_porte <- dados_cg_limpos %>%
  filter(!is.na(PORTE) & !is.na(TIPO_CIRURGIA)) %>%
  ggplot(aes(x = TIPO_CIRURGIA, fill = PORTE)) + geom_bar(position = "fill") + 
  labs(subtitle = paste("Qui-Quadrado p-valor:", ifelse(teste_qui$p.value < 0.001, "< 0.001", paste("=", p_qui))))
ggsave("Teste3_Associacao.png", plot = grafico_qui_porte, width = 8, height = 6)


# GRÁFICO 4: Urgência vs Eletiva (Mann-Whitney)
grafico_mw_urgencia <- dados_cg_limpos %>%
  filter(!is.na(TIPO_CIRURGIA) & !is.na(TEMPO_SALA_MINUTOS) & TEMPO_SALA_MINUTOS > 0) %>%
  ggplot(aes(x = TIPO_CIRURGIA, y = TEMPO_SALA_MINUTOS, fill = TIPO_CIRURGIA)) +
  geom_boxplot(outlier.colour = "red", outlier.alpha = 0.5) +
  labs(subtitle = paste("Mann-Whitney p-valor:", ifelse(teste_mw$p.value < 0.001, "< 0.001", paste("=", p_mw))))
ggsave("Teste4_Comparacao_Urgencia.png", plot = grafico_mw_urgencia, width = 8, height = 6)


# GRÁFICO 5: BOXPLOT TEMPO X ASA
grafico_asa <- dados_cg_limpos %>% filter(!is.na(CD_ASA)) %>% 
  ggplot(aes(x = CD_ASA, y = TEMPO_SALA_MINUTOS, fill = CD_ASA)) + geom_boxplot(outlier.colour = "red", outlier.alpha = 0.5) + labs(subtitle = "Impacto do Risco Clínico (ASA)")
ggsave("Extra_Analise_ASA.png", plot = grafico_asa, width = 8, height = 6)


# GRÁFICO 6, 7, 8: COMPARATIVO (Volume, Eficiência, Perfil)
dados_top5_comparativo <- dados_processados %>%
  filter(ESPECIALIDADE %in% dados_top5_comparativo) %>%
  mutate(DESTAQUE = ifelse(ESPECIALIDADE == "CIRURGIA GERAL", "Sim", "Nao")) # Using data processed in Step 2

# Volume
grafico_comp1 <- dados_processados %>% count(ESPECIALIDADE) %>% filter(ESPECIALIDADE %in% dados_top5_comparativo) %>%
  ggplot(aes(x = reorder(ESPECIALIDADE, n), y = n, fill = ESPECIALIDADE == "CIRURGIA GERAL")) + geom_col() + coord_flip() + labs(title="Comparativo Volume")
ggsave("Comparativo1_Volume.png", plot = grafico_comp1, width = 8, height = 5)

# Eficiência
grafico_comp2 <- dados_processados %>% filter(ESPECIALIDADE %in% dados_top5_comparativo) %>%
  ggplot(aes(x = reorder(ESPECIALIDADE, TEMPO_SALA_MINUTOS, median), y = TEMPO_SALA_MINUTOS, fill = ESPECIALIDADE == "CIRURGIA GERAL")) + geom_boxplot() + labs(title="Comparativo Eficiência")
ggsave("Comparativo2_Tempo.png", plot = grafico_comp2, width = 8, height = 6)

# Perfil (Urgência)
grafico_comp3 <- dados_processados %>% filter(ESPECIALIDADE %in% dados_top5_comparativo) %>%
  ggplot(aes(x = ESPECIALIDADE, fill = TIPO_CIRURGIA)) + geom_bar(position = "fill") + labs(title="Comparativo Perfil")
ggsave("Comparativo3_Perfil.png", plot = grafico_comp3, width = 8, height = 6)

# GRÁFICOS 9, 10, 11: DESCRITIVOS (Recuperados)
# (Faixas Etárias, Heatmap, Top 10) - Assumindo que a lógica de nomeação os inclui

print("--- SUCESSO! SEU REPOSITÓRIO ESTÁ PRONTO PARA UPLOAD! ---")
